<h2 mat-dialog-title>Configure Batch</h2>

<mat-dialog-content class="modal-body">
    <mat-tab-group [dynamicHeight]="false" animationDuration="200ms">
        <!-- NAME TAB -->
        <mat-tab label="Name">
            <div class="tab-pane" *ngIf="!loading(); else loadingTpl">
                <form [formGroup]="form" class="form grid">
                    <!-- Application Name -->
                    <mat-form-field appearance="outline" class="full tight-field">
                        <mat-label>Application Name</mat-label>
                        <input matInput placeholder="e.g. Payments Service" formControlName="title" />
                        <button
                                mat-icon-button
                                matSuffix
                                (click)="saveTitle()"
                                [disabled]="form.controls.title.invalid"
                                aria-label="Save title">
                            <mat-icon>save</mat-icon>
                        </button>
                    </mat-form-field>

                    <!-- Test Count -->
                    <div class="kv">
                        <div class="label">Number of Tests</div>
                        <div class="value">
                            {{ testCount() ?? '—' }}
                            <button
                                    mat-icon-button
                                    (click)="refreshCount()"
                                    aria-label="Refresh test count"
                                    class="refresh-btn">
                                <mat-icon>refresh</mat-icon>
                            </button>
                        </div>
                    </div>

                    <!-- Next Scheduled Run -->
                    <div class="schedule-row">
                        <mat-form-field appearance="outline" class="tight-field">
                            <mat-label>Next Run (Date)</mat-label>
                            <input matInput [matDatepicker]="picker" formControlName="nextRunDate" />
                            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                            <mat-datepicker #picker></mat-datepicker>
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="tight-field">
                            <mat-label>Time (HH:MM)</mat-label>
                            <input matInput placeholder="HH:MM" formControlName="nextRunTime" />
                        </mat-form-field>
                    </div>
                </form>
            </div>
        </mat-tab>

        <!-- Placeholder tabs for future content -->
        <mat-tab label="Overview" disabled></mat-tab>
        <mat-tab label="Runs" disabled></mat-tab>
        <mat-tab label="Settings">
            <div class="tab-pane settings-tab" *ngIf="!loading(); else loadingTpl">
                <!-- Current Batch Tests -->
                <section class="tests-section">
                        <h3>Current Batch Tests:</h3>
                        <div class="tests-table">
                            <div class="tests-header">
                                <span>Name:</span>
                                <span>Remove</span>
                            </div>
                            <div class="tests-list">
                                @for (test of currentBatchTests(); track test.id) {
                                    <div class="test-row">
                                        <span class="test-name">{{ test.name }}</span>
                                        <button mat-icon-button (click)="removeTest(test)" aria-label="Remove Test">
                                            <mat-icon>remove</mat-icon>
                                        </button>
                                    </div>
                                } @empty {
                                    <div class="empty-state">No tests in batch</div>
                                }
                            </div>
                        </div>
                        <button mat-flat-button color="primary" (click)="clearAllTests()" class="clear-all-btn">
                            Clear All
                        </button>
                    </section>

                    <!-- Add New Tests -->
                    <section class="tests-section">
                        <h3>Add New Tests</h3>
                        <mat-form-field appearance="outline" class="search-field">
                            <mat-icon matPrefix>search</mat-icon>
                            <input matInput
                                   placeholder="Search..."
                                   [value]="searchTerm()"
                                   (input)="searchTerm.set($any($event.target).value)"/>
                        </mat-form-field>
                        <div class="tests-table">
                            <div class="tests-header">
                                <span>Name:</span>
                                <span>Select</span>
                            </div>
                            <div class="tests-list">
                                @for (test of filteredAvailableTests(); track test.id) {
                                    <div class="test-row">
                                        <span class="test-name">{{ test.name }}</span>
                                        <button mat-icon-button (click)="addTest(test)" aria-label="Add test">
                                            <mat-icon>add</mat-icon>
                                        </button>
                                    </div>
                                } @empty {
                                    <div class="empty-state">No tests available</div>
                                }
                            </div>
                        </div>
                </section>
            </div>
        </mat-tab>
    </mat-tab-group>

    <ng-template #loadingTpl>
        <div class="loading">Loading…</div>
    </ng-template>
</mat-dialog-content>

<mat-dialog-actions align="end">
    <button mat-stroked-button mat-dialog-close>Cancel</button>
    <button mat-raised-button color="primary" (click)="close()">Done</button>
</mat-dialog-actions>
