<h2 mat-dialog-title>{{ isNew ? 'Create New Batch' : 'Configure Batch' }}</h2>

<mat-dialog-content class="modal-body">
    <form [formGroup]="form" class="batch-form">

        <!-- Overview -->
        <section class="form-section">
            <h3>Overview</h3>
            <mat-form-field appearance="outline" class="full-width">
                <mat-label>Application Name</mat-label>
                <input matInput placeholder="e.g. Payments Service" formControlName="batchName" />
            </mat-form-field>
        </section>

        <mat-divider></mat-divider>

        <!-- Schedule -->
        <section class="form-section">
            <h3>Schedule</h3>

            <!-- Frequency picker -->
            <mat-form-field appearance="outline">
                <mat-label>Frequency</mat-label>
                <mat-select [value]="scheduleFrequency()" (selectionChange)="onFrequencyChange($event.value)">
                    <mat-option value="daily">Daily</mat-option>
                    <mat-option value="weekly">Weekly</mat-option>
                </mat-select>
            </mat-form-field>

            <!-- Day picker (only for weekly) -->
            @if (scheduleFrequency() === 'weekly') {
                <mat-form-field appearance="outline">
                    <mat-label>Days</mat-label>
                    <mat-select multiple [value]="scheduleDays()" (selectionChange)="onDaysChange($event.value)">
                        @for (day of dayOptions; track day.value) {
                            <mat-option [value]="day.value">{{ day.label }}</mat-option>
                        }
                    </mat-select>
                </mat-form-field>
            }

            <!-- Time picker -->
            <mat-form-field appearance="outline">
                <mat-label>Time</mat-label>
                <input matInput type="time" [value]="scheduleTime()" (change)="onTimeChange($any($event.target).value)" />
            </mat-form-field>

            <!-- Generated cron expression (editable) -->
            <mat-form-field appearance="outline">
                <mat-label>Cron Expression</mat-label>
                <input matInput formControlName="cronExpression" placeholder="e.g. 0 30 14 * * MON,WED,FRI" />
            </mat-form-field>

            <div class="run-info">
                <span>Last Run: {{ form.get('lastRunTime')?.value || 'Never' }}</span>
            </div>
        </section>

        <mat-divider></mat-divider>

        <!-- Notifications -->
        <section class="form-section">
            <h3>Notifications</h3>
            <div class="form-row">
                <mat-form-field appearance="outline" class="flex-grow">
                    <mat-label>Search Participants</mat-label>
                    <input matInput
                           #participantInput
                           [matAutocomplete]="auto"
                           [formControl]="searchControl" />
                    <mat-autocomplete #auto="matAutocomplete"
                                      [displayWith]="displayParticipant"
                                      (optionSelected)="onParticipantSelected($event)"
                                      panelClass="participant-panel">
                        <mat-option *ngFor="let option of searchParticipants"
                                    [value]="option">
                            <span>{{ option.name }} — {{ option.email }}</span>
                        </mat-option>
                    </mat-autocomplete>
                </mat-form-field>
                <button mat-raised-button (click)="addParticipant()">Add</button>
            </div>

            <div class="participants-header">
                <label class="field-label">Active Participants</label>
                <button mat-button color="warn" (click)="removeParticipant()">Remove Selected</button>
            </div>
            <mat-selection-list #participantList dense>
                @for (participant of activeParticipants(); track participant.id) {
                    <mat-list-option [value]="participant">
                        {{ participant.name }} — {{ participant.email }} — {{ participant.role }}
                    </mat-list-option>
                }
            </mat-selection-list>
        </section>

        <mat-divider></mat-divider>

        <!-- Jobs -->
        <section class="form-section">
            <h3>Current Jobs</h3>
            <div class="job-list">
                @for (test of currentBatchTests(); track test.id) {
                    <div class="job-row">
                        <span>{{ test.name }}</span>
                        <button mat-icon-button (click)="removeTest(test)">
                            <mat-icon>close</mat-icon>
                        </button>
                    </div>
                } @empty {
                    <p class="empty-state">No tests in batch</p>
                }
            </div>
            <button mat-button color="warn" (click)="clearAllTests()">Clear All</button>

            <h3>Add Jobs</h3>
            <mat-form-field appearance="outline" class="full-width">
                <mat-icon matPrefix>search</mat-icon>
                <input matInput
                       placeholder="Search tests..."
                       [value]="searchTerm()"
                       (input)="searchTerm.set($any($event.target).value)" />
            </mat-form-field>
            <div class="job-list">
                @for (test of filteredAvailableTests(); track test.id) {
                    <div class="job-row">
                        <span>{{ test.name }}</span>
                        <button mat-icon-button (click)="addTest(test)">
                            <mat-icon>add</mat-icon>
                        </button>
                    </div>
                } @empty {
                    <p class="empty-state">No tests available</p>
                }
            </div>
        </section>
    </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
    <button mat-stroked-button mat-dialog-close>Cancel</button>
    <button mat-raised-button color="primary" (click)="save()">Save</button>
</mat-dialog-actions>
