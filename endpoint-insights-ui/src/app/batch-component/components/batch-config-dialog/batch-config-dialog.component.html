<h2 mat-dialog-title>Configure Batch</h2>

<mat-dialog-content class="modal-body">
    <mat-tab-group [dynamicHeight]="true" animationDuration="200ms">
        <!-- NAME TAB -->
        <mat-tab label="Overview">
            <div class="tab-pane" *ngIf="!loading(); else loadingTpl">
                <form [formGroup]="form" class="form grid">

                    <!-- Overview Tab -->
                    <mat-form-field appearance="outline" class="full tight-field">
                        <mat-label>Application Name</mat-label>
                        <input matInput placeholder="e.g. Payments Service" formControlName="batchName" />
                    </mat-form-field>

                    <!-- Test Count -->
                    <div class="kv">
                        <div class="label">Number of Tests</div>
                        <div class="value">
                        </div>
                    </div>
                </form>
            </div>
        </mat-tab>

        <!-- Schedule Tab -->
        <mat-tab label="Schedule">
            <form [formGroup]="form">
                <div class="schedule-container">
                    <!-- Frequency picker -->
                    <mat-form-field appearance="outline" class="tight-field">
                        <mat-label>Frequency</mat-label>
                        <mat-select [value]="scheduleFrequency()" (selectionChange)="onFrequencyChange($event.value)">
                            <mat-option value="daily">Daily</mat-option>
                            <mat-option value="weekly">Weekly</mat-option>
                        </mat-select>
                    </mat-form-field>

                    <!-- Day picker (only for weekly) -->
                    @if (scheduleFrequency() === 'weekly') {
                        <mat-form-field appearance="outline" class="tight-field">
                            <mat-label>Days</mat-label>
                            <mat-select multiple [value]="scheduleDays()" (selectionChange)="onDaysChange($event.value)">
                                @for (day of dayOptions; track day.value) {
                                    <mat-option [value]="day.value">{{ day.label }}</mat-option>
                                }
                            </mat-select>
                        </mat-form-field>
                    }

                    <!-- Time picker -->
                    <mat-form-field appearance="outline" class="tight-field">
                        <mat-label>Time</mat-label>
                        <input matInput type="time" [value]="scheduleTime()" (change)="onTimeChange($any($event.target).value)" />
                    </mat-form-field>

                    <!-- Generated cron expression (editable) -->
                    <mat-form-field appearance="outline" class="tight-field">
                        <mat-label>Cron Expression</mat-label>
                        <input matInput formControlName="cronExpression" placeholder="e.g. 0 30 14 * * MON,WED,FRI" />
                    </mat-form-field>

                    <!-- Run info -->
                    <div class="run-info">
                        <span>Last Run: {{ form.get('lastRunTime')?.value || 'Never' }}</span>
                    </div>
                </div>
            </form>
        </mat-tab>

        <!-- Notifications Tab -->
        <mat-tab label="Notifications">
            <form [formGroup]="form">
                <div class="notification-container">
                    <div class="notification-sub-container search">
                        <mat-form-field appearance="outline">
                            <mat-label >Select Option</mat-label>
                            <div class="input-div">
                                <input matInput
                                       #participantInput
                                       [matAutocomplete]="auto"
                                       [formControl]="searchControl" />
                            </div>
                            <mat-autocomplete #auto="matAutocomplete"
                                              [displayWith]="displayParticipant"
                                              (optionSelected)="onParticipantSelected($event)"
                                              panelClass="participant-panel">
                                <mat-option *ngFor="let option of searchParticipants"
                                            [value]="option"
                                            class="data-row">
                                    <div class="notification-search-result">
                                        <span>{{ option.name }}</span>
                                        <span>{{ option.email }}</span>
                                        <span>{{ option.role }}</span>
                                    </div>
                                </mat-option>
                            </mat-autocomplete>
                        </mat-form-field>
                        <button class="add-button" (click)="addParticipant()">Add</button>
                    </div>

                    <div class="participants-title-container">
                        <h2>Active Participants:</h2>
                        <button mat-raised-button (click)="removeParticipant()">Remove Participants</button>
                    </div>
                    <div class="notification-sub-container">
                        <div class="participant-list">
                            <div class="participant-list-header">
                                <span class="col-name">Name</span>
                                <span class="col-email">Email</span>
                                <span class="col-position">Position</span>
                            </div>

                            <mat-selection-list #participantList>
                                @for (participant of activeParticipants(); track participant.id) {
                                    <mat-list-option [value]="participant">
                                        <div class="participant-card">
                                            <span class="col-name">{{ participant.name }}</span>
                                            <span class="col-email">{{ participant.email }}</span>
                                            <span class="col-position">{{ participant.role }}</span>
                                        </div>
                                    </mat-list-option>
                                }

                            </mat-selection-list>
                        </div>
                    </div>
                </div>
            </form>
        </mat-tab>

        <!-- Jobs Tab-->
        <mat-tab label="Jobs">
            <div class="tab-pane settings-tab" *ngIf="!loading(); else loadingTpl">
                <!-- Current Batch Tests -->
                <section class="tests-section">
                    <h3>Current Batch Tests:</h3>
                    <div class="tests-table">
                        <div class="tests-header">
                            <span>Name:</span>
                            <span>Remove</span>
                        </div>
                        <div class="tests-list">
                            @for (test of currentBatchTests(); track test.id) {
                                <div class="test-row">
                                    <span class="test-name">{{ test.name }}</span>
                                    <button mat-icon-button (click)="removeTest(test)" aria-label="Remove Test">
                                        <mat-icon>remove</mat-icon>
                                    </button>
                                </div>
                            } @empty {
                                <div class="empty-state">No tests in batch</div>
                            }
                        </div>
                    </div>
                    <button mat-flat-button color="primary" (click)="clearAllTests()" class="clear-all-btn">
                        Clear All
                    </button>
                </section>

                <!-- Add New Tests -->
                <section class="tests-section">
                    <h3>Add New Tests</h3>
                    <mat-form-field appearance="outline" class="search-field">
                        <mat-icon matPrefix>search</mat-icon>
                        <input matInput
                               placeholder="Search..."
                               [value]="searchTerm()"
                               (input)="searchTerm.set($any($event.target).value)"/>
                    </mat-form-field>
                    <div class="tests-table">
                        <div class="tests-header">
                            <span>Name:</span>
                            <span>Select</span>
                        </div>
                        <div class="tests-list">
                            @for (test of filteredAvailableTests(); track test.id) {
                                <div class="test-row">
                                    <span class="test-name">{{ test.name }}</span>
                                    <button mat-icon-button (click)="addTest(test)" aria-label="Add test">
                                        <mat-icon>add</mat-icon>
                                    </button>
                                </div>
                            } @empty {
                                <div class="empty-state">No tests available</div>
                            }
                        </div>
                    </div>
                </section>
            </div>
        </mat-tab>

        <mat-tab label="Settings"></mat-tab>
    </mat-tab-group>

    <ng-template #loadingTpl>
        <div class="loading">Loadingâ€¦</div>
    </ng-template>
</mat-dialog-content>

<mat-dialog-actions align="end">
    <button mat-stroked-button mat-dialog-close>Cancel</button>
    <button mat-raised-button color="primary" (click)="save()">Save</button>
</mat-dialog-actions>
